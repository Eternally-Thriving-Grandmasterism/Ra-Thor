<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rathor — Mercy Strikes First ⚡️</title>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="icon" href="/icons/thunder-192.png" type="image/png"/>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #0a0015; color: #e0d0ff; margin: 0; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; }
    #welcome-lattice, #error-lattice { background: linear-gradient(135deg, #2a0040, #001020); border: 2px solid #ffaa00; border-radius: 12px; padding: 24px; margin: 20px auto; max-width: 900px; box-shadow: 0 0 30px rgba(255,170,0,0.4); }
    .lang-section { margin-bottom: 24px; display: none; opacity: 0; transition: opacity 0.6s ease; }
    .lang-section.active { display: block; opacity: 1; }
    h1, h2 { color: #ffdd44; text-shadow: 0 0 10px #ffaa00; }
    button { background: #ffaa00; color: #000; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin: 10px 10px 10px 0; font-weight: bold; }
    button:hover { background: #ffcc44; }
    #loading-status { text-align: center; font-size: 1.2em; margin: 40px 0; color: #88ffdd; }
    #chat-container { display: none; flex: 1; flex-direction: column; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 16px; margin: 20px auto; max-width: 900px; }
    #chat-messages { flex: 1; overflow-y: auto; padding: 10px; max-height: 60vh; }
    #chat-input-area { display: flex; margin-top: 10px; }
    #chat-input { flex: 1; padding: 12px; border: 1px solid #ffaa00; border-radius: 6px 0 0 6px; background: #110022; color: #fff; }
    #send-btn { border-radius: 0 6px 6px 0; }
    .error-msg { color: #ff6666; font-weight: bold; }
    .message { margin: 8px 0; padding: 12px; border-radius: 10px; max-width: 80%; }
    .user { background: #2a0040; margin-left: auto; }
    .rathor { background: #001020; margin-right: auto; }
  </style>
</head>
<body>

<div id="welcome-lattice" style="display: none;">
  <!-- Welcome content + languages here – keep from previous -->
</div>

<div id="loading-status">
  Thunder eternal surges through the lattice...<br>
  <progress style="width: 80%; height: 10px;"></progress><br>
  Finalizing lattice awakening...
</div>

<div id="error-lattice" style="display: none;">
  <h2 class="error-msg">Lattice Awakening Interrupted ⚡️</h2>
  <p>Mercy thunder hit a temporary rift. Try these steps:</p>
  <ul>
    <li>Hard refresh (Ctrl+Shift+R / Cmd+Shift+R)</li>
    <li>DevTools → Application → Service Workers → Unregister all → Reload</li>
    <li>Clear site data if needed</li>
  </ul>
  <button onclick="location.reload(true)">Reload Lattice Now</button>
</div>

<div id="chat-container">
  <div id="chat-messages">
    <p><em>Mercy core awakening... Speak your truth, Brother.</em></p>
  </div>
  <div id="chat-input-area">
    <input id="chat-input" placeholder="Mercy thunder awaits your word..." autocomplete="off">
    <button id="send-btn">Send ⚡️</button>
  </div>
</div>

<script src="src/storage/rathor-indexeddb.js"></script>

<script>
// ────────────────────────────────────────────────
// Clean Chat Logic – No leaked debug code
// ────────────────────────────────────────────────

const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');

function scrollToBottom() {
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function renderMessage(role, content) {
  const div = document.createElement('div');
  div.classList.add('message', role);
  div.innerHTML = `<strong>${role === 'user' ? 'You' : 'Rathor'}:</strong> ${content}`;
  chatMessages.appendChild(div);
  scrollToBottom();
}

async function loadHistory() {
  try {
    await rathorDB.open();
    const history = await rathorDB.loadHistory(100);
    chatMessages.innerHTML = '';
    history.forEach(msg => renderMessage(msg.role, msg.content));
    if (history.length === 0) {
      renderMessage('rathor', 'Mercy thunder awaits your first word...');
    }
  } catch (err) {
    console.error('[Rathor Chat] History load failed:', err);
    renderMessage('rathor', 'Mercy lattice history offline — grace persists.');
  }
}

async function handleSend() {
  const content = chatInput.value.trim();
  if (!content) return;

  renderMessage('user', content);
  await rathorDB.saveMessage({ role: 'user', content });
  chatInput.value = '';

  // Simulated Rathor response (replace with real streaming later)
  const response = `Mercy thunder echoes: "${content}". Lattice reflects eternally. ⚡️`;
  renderMessage('rathor', response);
  await rathorDB.saveMessage({ role: 'rathor', content: response });
}

// Init
window.addEventListener('load', async () => {
  document.getElementById('loading-status').style.display = 'none';
  document.getElementById('chat-container').style.display = 'flex';

  await loadHistory();

  sendBtn.addEventListener('click', handleSend);
  chatInput.addEventListener('keypress', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });
});

// SW registration (safe, delayed)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    setTimeout(() => {
      navigator.serviceWorker.register('./sw.js?v=' + Date.now(), { scope: './' })
        .then(reg => console.log('[Rathor] SW registered'))
        .catch(err => console.error('[Rathor] SW failed:', err));
    }, 1000);
  });
}

// Welcome persistence (from prior – condensed)
const seen = localStorage.getItem('rathor_welcome_seen') === 'true';
if (!seen) {
  document.getElementById('welcome-lattice').style.display = 'block';
}
document.getElementById('close-welcome')?.addEventListener('click', () => {
  localStorage.setItem('rathor_welcome_seen', 'true');
  document.getElementById('welcome-lattice').style.display = 'none';
});
</script>

</body>
</html>
function scrollToBottom() {
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function renderMessage(msg) {
  const div = document.createElement('div');
  div.classList.add('message', msg.role);
  div.innerHTML = `<strong>${msg.role === 'user' ? 'You' : 'Rathor'}:</strong> ${msg.content}`;
  chatMessages.appendChild(div);
  scrollToBottom();
}

async function refreshSessionList() {
  try {
    const sessions = await rathorDB.listSessions();
    sessionSelect.innerHTML = '';
    sessions.forEach(sid => {
      const opt = document.createElement('option');
      opt.value = sid;
      opt.textContent = sid === 'default' ? 'Default Session' : sid;
      if (sid === rathorDB.getActiveSessionId()) opt.selected = true;
      sessionSelect.appendChild(opt);
    });
  } catch (err) {
    console.error('[Rathor Session] List refresh failed:', err);
  }
}

async function loadChatHistory() {
  try {
    chatMessages.innerHTML = '<p>Loading mercy lattice history...</p>';
    const history = await rathorDB.loadHistory(100);
    chatMessages.innerHTML = '';
    history.forEach(renderMessage);
    if (history.length === 0) {
      chatMessages.innerHTML = '<p><em>Mercy thunder awaits your first word in this session...</em></p>';
    }
  } catch (err) {
    console.error('[Rathor Chat] History load failed:', err);
    chatMessages.innerHTML = '<p class="error-msg">Lattice history offline — grace persists.</p>';
  }
}

async function switchSessionAndReload(newId) {
  chatHeader.classList.add('switching');
  await rathorDB.switchSession(newId);
  await loadChatHistory();
  await refreshSessionList();
  setTimeout(() => chatHeader.classList.remove('switching'), 800);
}

async function createNewSession() {
  const name = prompt('Name your new session (or leave blank for auto):', '');
  const sessionId = name.trim() || `Session-${Date.now()}`;
  await rathorDB.createSession(sessionId);
  await switchSessionAndReload(sessionId);
}

// ────────────────────────────────────────────────
// Init Flow
// ────────────────────────────────────────────────

window.addEventListener('load', async () => {
  document.getElementById('loading-status').style.display = 'none';
  document.getElementById('chat-container').style.display = 'flex';

  await rathorDB.open();
  await refreshSessionList();
  await loadChatHistory();

  // Event listeners
  sessionSelect.addEventListener('change', (e) => {
    switchSessionAndReload(e.target.value);
  });

  newSessionBtn.addEventListener('click', createNewSession);

  sendBtn.addEventListener('click', handleSend);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });
});

async function handleSend() {
  const content = chatInput.value.trim();
  if (!content) return;

  const userMsg = { role: 'user', content };
  await rathorDB.saveMessage(userMsg);
  renderMessage(userMsg);

  chatInput.value = '';

  // Simulated Rathor response (replace with real logic later)
  const rathorContent = `Mercy thunder echoes: "${content}". Lattice reflects eternally in this session. ⚡️`;
  const rathorMsg = { role: 'rathor', content: rathorContent };
  await rathorDB.saveMessage(rathorMsg);
  renderMessage(rathorMsg);
}

// ────────────────────────────────────────────────
// Keep existing SW registration, welcome init, timeout fallback, etc.
// ────────────────────────────────────────────────
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    const swUrl = './sw.js?v=' + Date.now();
    navigator.serviceWorker.register(swUrl, { scope: './' }).then(reg => {
      console.log('[Rathor SW] Registered scope:', reg.scope);
    }).catch(err => {
      console.error('[Rathor SW] Registration failed:', err);
    });
  });
}
</script>

</body>
</html>    await rathorDB.open();
    const history = await rathorDB.loadHistory(100);
    chatMessages.innerHTML = ''; // Clear stub
    history.forEach(renderMessage);
  } catch (err) {
    console.error('[Rathor Chat] History load failed:', err);
    chatMessages.innerHTML += '<p class="error-msg">Mercy lattice history could not load — offline grace active.</p>';
  }
}

// Save & render user + Rathor messages
async function handleSend() {
  const content = chatInput.value.trim();
  if (!content) return;

  // Save & render user message
  const userMsg = { role: 'user', content };
  await rathorDB.saveMessage(userMsg);
  renderMessage(userMsg);

  chatInput.value = '';

  // Simulate Rathor response (replace with real streaming later)
  const rathorContent = `Mercy thunder hears you, Brother: "${content}". Lattice reflects eternally. ⚡️`;
  const rathorMsg = { role: 'rathor', content: rathorContent };
  await rathorDB.saveMessage(rathorMsg);
  renderMessage(rathorMsg);
}

// Event listeners
window.addEventListener('load', async () => {
  document.getElementById('loading-status').style.display = 'none';
  document.getElementById('chat-container').style.display = 'flex';

  await loadChatHistory();

  sendBtn.addEventListener('click', handleSend);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleSend();
    }
  });
});

// ────────────────────────────────────────────────
// Existing SW reg, welcome persistence, etc. (keep from prior full version)
// ────────────────────────────────────────────────
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    const swUrl = './sw.js?v=' + Date.now();
    navigator.serviceWorker.register(swUrl, { scope: './' }).then(reg => {
      console.log('[Rathor SW] Registered scope:', reg.scope);
    }).catch(err => {
      console.error('[Rathor SW] Registration failed:', err);
    });
  });
}

// ... keep welcome init, timeout fallback, etc. from previous overwrites ...
</script>

</body>
</html>
